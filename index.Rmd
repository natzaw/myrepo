---
title: "CompMusic Porftolio"
author: "Natalia Zawada"
date: "21/02/2021"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    orientation: columns
    storyboard: true
    theme: lumen
---

```{r}
library(flexdashboard)

library(tidyverse)
library(tidymodels)

library(ggdendro)
library(ggthemes)
library(ggplot2)
library(plotly)
library(dplyr)

library(spotifyr)
library(compmus)





```

Introduction
=========================================

** Intro still in progress... 

I will be exploring the genre of techno and house. 
Techno emerged in the late 80's from the wide availability of synthesizers and the inspiration of early electronic music artist like Kraftwerk, Giorgio Mordor, Depech Mode, Front 242. 
The techno seed sprouted at about the same time in America and Europe. 
Chicago was the home of house and acid house, centering around Trax Records.
Detriot was the home of techno with many founding fathers including Juan Atkins, Derrick May, Jeff Mills. They owned MetroPlex, Transmat Records and UR Records respectively. 
Techno and house in Europe had its strong beginnings in Germany with hot pockets in Belguim and UK. Tresor Records in Berlin and R&S Records in Ghent ignited the techno flame. 

My corpus, for now, consists of three playlists - Detriot, Chicago, Europe(berlin). I looked at the record releases from the above mentioned labels, from first releases at around 1987 until about 1993, and searched for available tracks on Spotify. 

From its inception until early 1990's, there is clear geographical comparison to look at - Detriot Techno vs Berlin Techno. After 1993 or so, many Detriot founders move to Berlin. 
There is also a clear comparison between Chicago Acid House and Berlin/Detroit Techno


If space and scope permit, I would also like to look at the comparison between early techno and proto-techno (late 70's and 80's), as well as early techno and current techno.

```{r, echo=FALSE}



```
Visualizations {.storyboard}
=========================================

### Danceability vs Energy 

```{r, echo=FALSE}

my_id <- 'natzaw'


detriot <- get_playlist_audio_features(my_id, "7zJxmBOEVValZYC0zmfLrf")
chicago <- get_playlist_audio_features(my_id, "5ZixL1Pb2mzyED9hSQ8y2G")
europe  <- get_playlist_audio_features(my_id, "1YnOhBchUwaRFOqzWZp4CV")

ggplot(detriot, (aes(energy, danceability, color = key, size = tempo ))) +
  geom_point() +
  ggtitle("Detriot")

ggplot(chicago, (aes(energy, danceability, color = key, size = tempo))) +
  geom_point() + 
  ggtitle("Chicago")

ggplot(europe, (aes(energy, danceability, color = key, size = tempo))) +
  geom_point() + 
  ggtitle("Berlin")
```

***

Commentary Here

### Valence vs Loudness

```{r, echo=FALSE}
ggplot(detriot, (aes(valence, loudness, color = mode))) +
  geom_point() +
  ggtitle("Detriot")

ggplot(chicago, (aes(valence, loudness, color = mode))) +
  geom_point() + 
  ggtitle("Chicago")

ggplot(europe, (aes(valence, loudness, color = mode))) +
  geom_point() + 
  ggtitle("Berlin")
```

***

Commentary Here

### Chrome Features Chromagram + DTW

```{r, echo=FALSE}

# # CHROMAGRAM
# 
# # load track 
# 
# trackName <-                                                 # change trackName 
#   get_tidy_audio_analysis("6IQILcYkN2S2eSu5IHoPEH") %>%      # change URI 
#   select(segments) %>%
#   unnest(segments) %>%
#   select(start, duration, pitches)
# 
# 
# 
# # gather_chroma 
# 
# trackName %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>% 
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   theme_minimal() +
#   scale_fill_viridis_c()
# 
# # DTW = compmus_long_distance:plot the distances between the chroma vectors in two different pieces  
# 
# compmus_long_distance(
#   tallis %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
#   chapelle %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
#   feature = pitches,
#   method = "euclidean"
# ) %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_equal() +
#   labs(x = "The Tallis Scholars", y = "La Chapelle Royale") +
#   theme_minimal() +
#   scale_fill_viridis_c(guide = NULL)


```

***

Commentary Here

### Ceptogram + SSM

```{r, echo=FALSE}

# # CEPTOGRAM: check page for common norm, distance, summary combinations
# 
# # load track features 
# trackName <-                                            # change trackName
#   get_tidy_audio_analysis("5ZLkc5RY1NM4FtGWEd6HOE") %>% # Change URI.
#   compmus_align(bars, segments) %>%                     # Change `bars`
#   select(bars) %>%                                      #   in all three
#   unnest(bars) %>%                                      #   of these lines
#   mutate(                                               # to either: sections, bars, beats, tatums
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "rms", norm = "euclidean"              # Change summary & norm 
#       )                                                 # summary : mean, acentre, rms, max
#   ) %>%                                                 # norm: manhattan, euclidean, chebyshev
#   mutate(
#     timbre =
#       map(segments,
#         compmus_summarise, timbre,
#         method = "rms", norm = "euclidean"              # Change summary & norm.
#       )
#   )
# 
# # ceptogram; compmus_gather_timbre
# 
# trackName %>%                                                 # change trackName 
#   compmus_gather_timbre() %>% 
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = basis,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   scale_fill_viridis_c() +                              
#   theme_classic()
# 
# # self-similarity matrix(timbre): check page for other combos (pitches )
# bzt %>%
#   compmus_self_similarity(timbre, "cosine") %>% 
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   scale_fill_viridis_c(guide = "none") +
#   theme_classic() +
#   labs(x = "", y = "")

```

***

In this section, I will compare four tracks: Acid House vs. Chicag House and Berlin Techni vs Detroit Techno 

### Chordogram

```{r, echo=FALSE}

# #chordogram
# circshift <- function(v, n) {
#   if (n == 0) v else c(tail(v, n), head(v, -n))
# }
# 
# #      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
# major_chord <-
#   c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
# minor_chord <-
#   c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
# seventh_chord <-
#   c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)
# 
# major_key <-
#   c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
# minor_key <-
#   c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
# 
# chord_templates <-
#   tribble(
#     ~name, ~template,
#     "Gb:7", circshift(seventh_chord, 6),
#     "Gb:maj", circshift(major_chord, 6),
#     "Bb:min", circshift(minor_chord, 10),
#     "Db:maj", circshift(major_chord, 1),
#     "F:min", circshift(minor_chord, 5),
#     "Ab:7", circshift(seventh_chord, 8),
#     "Ab:maj", circshift(major_chord, 8),
#     "C:min", circshift(minor_chord, 0),
#     "Eb:7", circshift(seventh_chord, 3),
#     "Eb:maj", circshift(major_chord, 3),
#     "G:min", circshift(minor_chord, 7),
#     "Bb:7", circshift(seventh_chord, 10),
#     "Bb:maj", circshift(major_chord, 10),
#     "D:min", circshift(minor_chord, 2),
#     "F:7", circshift(seventh_chord, 5),
#     "F:maj", circshift(major_chord, 5),
#     "A:min", circshift(minor_chord, 9),
#     "C:7", circshift(seventh_chord, 0),
#     "C:maj", circshift(major_chord, 0),
#     "E:min", circshift(minor_chord, 4),
#     "G:7", circshift(seventh_chord, 7),
#     "G:maj", circshift(major_chord, 7),
#     "B:min", circshift(minor_chord, 11),
#     "D:7", circshift(seventh_chord, 2),
#     "D:maj", circshift(major_chord, 2),
#     "F#:min", circshift(minor_chord, 6),
#     "A:7", circshift(seventh_chord, 9),
#     "A:maj", circshift(major_chord, 9),
#     "C#:min", circshift(minor_chord, 1),
#     "E:7", circshift(seventh_chord, 4),
#     "E:maj", circshift(major_chord, 4),
#     "G#:min", circshift(minor_chord, 8),
#     "B:7", circshift(seventh_chord, 11),
#     "B:maj", circshift(major_chord, 11),
#     "D#:min", circshift(minor_chord, 3)
#   )
# 
# key_templates <-
#   tribble(
#     ~name, ~template,
#     "Gb:maj", circshift(major_key, 6),
#     "Bb:min", circshift(minor_key, 10),
#     "Db:maj", circshift(major_key, 1),
#     "F:min", circshift(minor_key, 5),
#     "Ab:maj", circshift(major_key, 8),
#     "C:min", circshift(minor_key, 0),
#     "Eb:maj", circshift(major_key, 3),
#     "G:min", circshift(minor_key, 7),
#     "Bb:maj", circshift(major_key, 10),
#     "D:min", circshift(minor_key, 2),
#     "F:maj", circshift(major_key, 5),
#     "A:min", circshift(minor_key, 9),
#     "C:maj", circshift(major_key, 0),
#     "E:min", circshift(minor_key, 4),
#     "G:maj", circshift(major_key, 7),
#     "B:min", circshift(minor_key, 11),
#     "D:maj", circshift(major_key, 2),
#     "F#:min", circshift(minor_key, 6),
#     "A:maj", circshift(major_key, 9),
#     "C#:min", circshift(minor_key, 1),
#     "E:maj", circshift(major_key, 4),
#     "G#:min", circshift(minor_key, 8),
#     "B:maj", circshift(major_key, 11),
#     "D#:min", circshift(minor_key, 3)
#   )
# 
# #load track
# twenty_five <-
#   get_tidy_audio_analysis("5UVsbUV0Kh033cqsZ5sLQi") %>%
#   compmus_align(sections, segments) %>%
#   select(sections) %>%
#   unnest(sections) %>%
#   mutate(
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "mean", norm = "manhattan"
#       )
#   )
# 
# twenty_five %>% 
#   compmus_match_pitch_template(
#     key_templates,         # Change to chord_templates if descired
#     method = "euclidean",  # Try different distance metrics
#     norm = "manhattan"     # Try different norms
#   ) %>%
#   ggplot(
#     aes(x = start + duration / 2, width = duration, y = name, fill = d)
#   ) +
#   geom_tile() +
#   scale_fill_viridis_c(guide = "none") +
#   theme_minimal() +
#   labs(x = "Time (s)", y = "")
# 
# # track level summaries 
# 
# bebop <-
#   get_playlist_audio_features(
#     "thesoundsofspotify",
#     "55s8gstHcaCyfU47mQgLrB"
#   ) %>%
#   slice(1:30) %>%
#   add_audio_analysis()
# 
# bigband <-
#   get_playlist_audio_features(
#     "thesoundsofspotify",
#     "2cjIvuw4VVOQSeUAZfNiqY"
#   ) %>%
#   slice(1:30) %>%
#   add_audio_analysis()
# 
# jazz <-
#   bebop %>%
#   mutate(genre = "Bebop") %>%
#   bind_rows(bigband %>% mutate(genre = "Big Band"))
# 
# #summarize statistics 
# 
# jazz %>%
#   mutate(
#     sections =
#       map(
#         sections,                                    # sections or segments
#         summarise_at,
#         vars(tempo, loudness, duration),             # features of interest
#         list(section_mean = mean, section_sd = sd)   # aggregation functions
#       )
#   ) %>%
#   unnest(sections) %>%
#   ggplot(
#     aes(
#       x = tempo,
#       y = tempo_section_sd,
#       colour = genre,
#       alpha = loudness
#     )
#   ) +
#   geom_point(aes(size = duration / 60)) +
#   geom_rug() +
#   theme_minimal() +
#   ylim(0, 5) +
#   labs(
#     x = "Mean Tempo (bpm)",
#     y = "SD Tempo",
#     colour = "Genre",
#     size = "Duration (min)",
#     alpha = "Volume (dBFS)"
#   )
# 
# # comparing average timbre coefficients in bebop and big band
# 
# jazz %>%
#   mutate(
#     timbre =
#       map(
#         segments,
#         compmus_summarise,
#         timbre,
#         method = "mean"
#       )
#   ) %>%
#   select(genre, timbre) %>%
#   compmus_gather_timbre() %>%
#   ggplot(aes(x = basis, y = value, fill = genre)) +
#   geom_violin() +
#   scale_fill_viridis_d() +
#   labs(x = "Spotify Timbre Coefficients", y = "", fill = "Genre")

```

***

Here, I will look at...

### Novelty Function:Loudness & Tempogram 

```{r, echo=FALSE}

# # novelty function 
# 
# #  work directly with the segments
# 
# pata_pata <-
#   get_tidy_audio_analysis("3uy90vHHATPjtdilshDQDt") %>%
#   select(segments) %>%
#   unnest(segments)
# 
# # can compute an energy-based novelty function based on Spotify’s loudness estimates
# 
# pata_pata %>%
#   mutate(loudness_max_time = start + loudness_max_time) %>%
#   arrange(loudness_max_time) %>%
#   mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
#   ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
#   geom_line() +
#   xlim(0, 30) +
#   theme_minimal() +
#   labs(x = "Time (s)", y = "Novelty")
# 
# # can use similar approaches for chromagrams and cepstrograms
# 
# # compmus_gather_chroma
# 
# pata_pata %>%
#   mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
#   arrange(start) %>%
#   mutate(pitches = map2(pitches, lag(pitches), `-`)) %>%
#   slice(-1) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = pmax(0, value)
#     )
#   ) +
#   geom_tile() +
#   scale_fill_viridis_c(guide = "none") +
#   xlim(0, 30) +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   theme_classic()
# 
# # compmus_gather_timbre
# 
# pata_pata %>%
#   arrange(start) %>%
#   mutate(timbre = map2(timbre, lag(timbre), `-`)) %>%
#   slice(-1) %>%
#   compmus_gather_timbre() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = basis,
#       fill = pmax(0, value)
#     )
#   ) +
#   geom_tile() +
#   scale_fill_viridis_c(guide = "none") +
#   xlim(0, 30) +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   theme_classic()
# 
# # temporgrams 
# 
# graveola <- get_tidy_audio_analysis("6PJasPKAzNLSOzxeAH33j2")
# 
# graveola %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()
# 
# #  Wrapping into a cyclic tempogram 
# graveola %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()

```

***

Commentary Here

### Loudness

```{r, echo=FALSE}

```

***

Commentary Here

### Classification

```{r, echo=FALSE}

#load libraries 

# library(tidyverse)
# library(tidymodels)
# library(ggdendro)
# library(heatmaply)
# library(spotifyr)
# library(compmus)

# set up
get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>%
    collect_predictions() %>%
    conf_mat(truth = outcome, estimate = .pred_class)
}

get_pr <- function(fit) {
  fit %>%
    conf_mat_resampled() %>%
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>%
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>%
    ungroup() %>% filter(Prediction == Truth) %>%
    select(class = Prediction, precision, recall)
}

#classification

berlin <- get_playlist_audio_features("spotify", "1YnOhBchUwaRFOqzWZp4CV")
detroit <- get_playlist_audio_features("spotify", "7zJxmBOEVValZYC0zmfLrf")
chicago <- get_playlist_audio_features("spotify", "5ZixL1Pb2mzyED9hSQ8y2G")
techno_acid <-
  bind_rows(
    berlin %>% mutate(playlist = "Early Berlin") %>% slice_head(n = 10),
    detroit %>% mutate(playlist = "Early Detroit") %>% slice_head(n = 10),
    chicago %>% mutate(playlist = "Early Chicago") %>% slice_head(n = 10)
  )

# bind the three playlists together using the trick from the beginning of the course, transpose the chroma vectors to a common tonic using the compmus_c_transpose function, and then summarise the vectors like we did when generating chromagrams and cepstrograms

techno_acid_features <-
  techno_acid %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>%
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

#pre-processing

techno_acid_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = techno_acid_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].

# cross- validation

techno_acid_cv <- techno_acid_features %>% vfold_cv(5)

#classification algorithms: kNN

# Decision Trees

# Random Forest

forest_model <-
  rand_forest() %>%
  set_mode("classification") %>%
  set_engine("ranger", importance = "impurity")
techno_acid_forest <-
  workflow() %>%
  add_recipe(techno_acid_recipe) %>%
  add_model(forest_model) %>%
  fit_resamples(
    techno_acid_cv,
    control = control_resamples(save_pred = TRUE)
  )

techno_acid_forest %>% get_pr()

workflow() %>%
  add_recipe(techno_acid_recipe) %>%
  add_model(forest_model) %>%
  fit(techno_acid_features) %>%
  pluck("fit", "fit", "fit") %>%
  ranger::importance() %>%
  enframe() %>%
  mutate(name = fct_reorder(name, value)) %>%
  ggplot(aes(name, value)) +
  geom_col() +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")

# ggplot

techno_acid_features %>%
  ggplot(aes(x = instrumentalness, y = danceability, colour = playlist, size = loudness)) +
  geom_point(alpha = 0.8) +
  scale_color_viridis_d() +
  labs(
    x = "Instrumentalness",
    y = "Danceability",
    size = "Loudness",
    colour = "Playlist"
  )

#clustering 

# early_chicago <-
#   get_playlist_audio_features("Early Chicago", "5ZixL1Pb2mzyED9hSQ8y2G") %>%
#   add_audio_analysis() %>%
#   mutate(
#     segments = map2(segments, key, compmus_c_transpose),
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "mean", norm = "manhattan"
#       ),
#     timbre =
#       map(
#         segments,
#         compmus_summarise, timbre,
#         method = "mean"
#       )
#   ) %>%
#   mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
#   mutate_at(vars(pitches, timbre), map, bind_rows) %>%
#   unnest(cols = c(pitches, timbre))
# 
# # pre-processing 
# 
# chicago_juice <-
#   recipe(
#     track.name ~
#       danceability +
#       energy +
#       loudness +
#       speechiness +
#       acousticness +
#       instrumentalness +
#       liveness +
#       valence +
#       tempo +
#       duration +
#       C + `C#|Db` + D + `D#|Eb` +
#       E + `F` + `F#|Gb` + G +
#       `G#|Ab` + A + `A#|Bb` + B +
#       c01 + c02 + c03 + c04 + c05 + c06 +
#       c07 + c08 + c09 + c10 + c11 + c12,
#     data = early_chicago
#   ) %>%
#   step_center(all_predictors()) %>%
#   step_scale(all_predictors()) %>% 
#   # step_range(all_predictors()) %>% 
#   prep(early_chicago %>% mutate(track.name = str_trunc(track.name, 20))) %>%
#   juice() %>%
#   column_to_rownames("track.name")
# 
# # computing disctances 
# 
# acid_dist <- dist(chicago_juice, method = "euclidean")
# 
# # hierarchical clustering
# 
# chicago_dist %>% 
#   hclust(method = "average") %>% # Try single, average, and complete.
#   dendro_data() %>%
#   ggdendrogram()
```

***

Commentary Here

### Chart 3

```{r, echo=FALSE}

```

***

Commentary Here

### Chart 3

```{r, echo=FALSE}

```

***

Commentary Here

### Chart 3

```{r, echo=FALSE}

```

***

Commentary Here


Discussion
=========================================

Discussion Here




