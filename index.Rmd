---
title: "CompMusic Porftolio"
author: "Natalia Zawada"
date: "21/02/2021"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    orientation: columns
    storyboard: true
    theme: lumen
---

```{r, echo=FALSE}
library(flexdashboard)

library(tidyverse)
library(tidymodels)

library(ggdendro)
library(ggthemes)
library(ggplot2)
library(plotly)
library(dplyr)

library(spotifyr)
library(compmus)





```

Introduction
=========================================
{=html}
Ever since moving to Amsterdam 7 years ago, I’ve been in the midst of a techno love affair. The bass enveloped me, the beat hypnotized me and the high hat had me twirling till dawn. As much as my familiarity has expanded over the years, I haven’t really delved into its origins and explored its roots. This project has provided me the opportunity to do so.  In particular, I will explore sub-genres of Techno, House and Acid; gain insights about their similarities and differences at the genre and track level.  

The techno seed sprouted at about the same time in America and Europe in the late 80’s thanks to the wide availability of synthesizers and drum machines. Artist took their inspirations from early electronic musicians like Kraftwerk, Giorgio Mordor, and Depeche Mode. Chicago is known as the home of house music, getting its name from “bedroom style” production and evolving from the dying disco era, with funky groove, piano riffs and catchy chorus. The industrial landscape of Detroit inspired the rougher, faster and futuristic sound of techno. Across the pond, the rave scene in Germany, Netherlands, Belgium and UK was exploding and expanding the variants of techno and acid, as well as house.  

To compile the project corpus, I searched for techno and house record labels that began in the late 80’s/early 90’s and searched for available tracks on Spotify. I created four playlists:  

<<<<<<< HEAD
<a href = "https://open.spotify.com/playlist/1YnOhBchUwaRFOqzWZp4CV?si=hc-Wa8lHQMGkIxTfyKyMyA"> Early Europe Techno </a> 
=======
<a href = "https://open.spotify.com/playlist/1YnOhBchUwaRFOqzWZp4CV?si=hc-Wa8lHQMGkIxTfyKyMyA"> Early Europe Techno </a>
>>>>>>> ff03dc142cadf257ae3cd21e79223362f74a9377

Tresor Records: Berlin, 1991 

R&S Records: Ghent, 1983 

Djax-Up-Beat Records: Eindhoven, 1989 

Rising High Records: London, 1991 

< a href = "https://open.spotify.com/playlist/7zJxmBOEVValZYC0zmfLrf?si=2VKWRtBwSpKEWkSSabgM9w"> Early Detroit Techno </a>

Underground Resistance Records: 1990 

Transmat Records: 1986  

Metroplex: 1985  

<<<<<<< HEAD
<a href = "https://open.spotify.com/playlist/3CnYQrWpRhyWqYmoUyQdtY?si=VoWP3226Svehn5Tlai4zWQEarly"> Chicago House </a> 

Trax Records: 1984 

< a href = "https://open.spotify.com/playlist/1Ybjwa5pLtVCqlXrIrOOiF?si=eMeDPBgtQ_a_2sVrqi4LRw"> Early Acid </a>  
=======
<a href = "https://open.spotify.com/playlist/3CnYQrWpRhyWqYmoUyQdtY?si=VoWP3226Svehn5Tlai4zWQEarly"> Chicago House </a>  

Trax Records: 1984 

< a href = "https://open.spotify.com/playlist/1Ybjwa5pLtVCqlXrIrOOiF?si=eMeDPBgtQ_a_2sVrqi4LRw"> Early Acid </a> 
>>>>>>> ff03dc142cadf257ae3cd21e79223362f74a9377

Mix of labels above  


Spotify user : natzaw

```{r, echo=FALSE}

# Load playlists and tracks 

my_id <- 'natzaw'


detroitTechno <- get_playlist_audio_features(my_id, "7zJxmBOEVValZYC0zmfLrf")
europeTechno  <- get_playlist_audio_features(my_id, "1YnOhBchUwaRFOqzWZp4CV")

chicagoHouse <- get_playlist_audio_features(my_id, "5ZixL1Pb2mzyED9hSQ8y2G")

earlyAcid  <- get_playlist_audio_features(my_id, "1Ybjwa5pLtVCqlXrIrOOiF")
chicagoAcid <- get_playlist_audio_features(my_id, "3CnYQrWpRhyWqYmoUyQdtY")


```
Visualizations {.storyboard}
=========================================

### Europe Techno Vs Detriot Techno 

```{r, echo=FALSE}

# ## load spotify
# my_id <- 'natzaw'
# 
# detroitTechno <- get_playlist_audio_features(my_id, "7zJxmBOEVValZYC0zmfLrf")
# europeTechno  <- get_playlist_audio_features(my_id, "1YnOhBchUwaRFOqzWZp4CV")


#danceacility
dt_dance <- detroitTechno$danceability
et_dance <- europeTechno$danceability

dtdance <- sample(dt_dance, size = 80)
etdance <- sample(et_dance, size = 80)

# energy
dt_energy <- detroitTechno$energy
et_energy <- europeTechno$energy

dtenergy <- sample(dt_energy, size = 80)
etenergy <- sample(et_energy, size = 80)

# valence
dt_val <- detroitTechno$valence
et_val <- europeTechno$valence

dtval <- sample(dt_val, size = 80)
etval <- sample(et_val, size = 80)

#instrumentalness
dt_int <- detroitTechno$valence
et_int <- europeTechno$valence

dtint <- sample(dt_int, size = 80)
etint <- sample(et_int, size = 80)

head(dtint)
str(dtint)

# Create data frame


x = c(c(dtenergy), c(dtdance), c(dtval), c(dtint), c(etenergy), c(etdance), c(etval), c(etint))
y = rep(c("Detroit", "Detroit","Detroit","Detroit", "Europe", "Europe", "Europe", "Europe"))
 z = rep(c("Energy", "Danceability", "Valence", "Insturmentalness"), 2)


energy3 = data.frame(x, y, z)

# Check data fram 
# str(energy3)
# head(energy3)

# Box Plot 
ggplot(energy3, aes(y, x, fill= factor(z))) +
  geom_boxplot() + 
  theme(axis.title = element_blank()) + 
  labs(
    title="Detroit Techno vs Europe Techno", 
    fill = "Features", 
    x = "Detroit Techno vs Europe Techno")

# point plot 
ggplot(detroitTechno, (aes(tempo, loudness, color = key, size = energy))) +
  geom_point() +
  ggtitle("Detriot Techno")

ggplot(chicagoHouse, (aes(tempo, loudness, color = key, size = energy ))) +
  geom_point() +
  ggtitle("Europe Techno")


```

***

As expected, techno in Detroit and Europe are quite similar. Danceability are valence factors are roughly the same, giving the rave parties similar vibes in both regions. Detroit has slightly more median energy but lower instrumentalness.  

European techno has more consistent tempo between 120 –125 bpm and more consistent loudness centering around –10 db. It also interesting to see here that the outliers have higher key values of above 8 and generally lower energy values.  

Detroit techno has greater bpm spread with several tracks going above 130 bmp and a few hovering around 110. Loudness also has slighter greater spread and more tracks passing the –15 db threshold. In contrast to European techno, the outliers tend to have lower key values and higher key values.


### Detroit Techno Vs Chicago House 

```{r, echo=FALSE}

## load spotify
my_id <- 'natzaw'

detroitTechno <- get_playlist_audio_features(my_id, "7zJxmBOEVValZYC0zmfLrf")
chicagoHouse <- get_playlist_audio_features(my_id, "5ZixL1Pb2mzyED9hSQ8y2G")


#danceacility
dt_dance <- detroitTechno$danceability
ch_dance <- chicagoHouse$danceability

dtdance <- sample(dt_dance, size = 80)
chdance <- sample(ch_dance, size = 80)

# energy
dt_energy <- detroitTechno$energy
ch_energy <- chicagoHouse$energy

dtenergy <- sample(dt_energy, size = 80)
chenergy <- sample(ch_energy, size = 80)

# valence
dt_val <- detroitTechno$valence
ch_val <- chicagoHouse$valence

dtval <- sample(dt_val, size = 80)
chval <- sample(ch_val, size = 80)

#instrumentalness
dt_int <- detroitTechno$valence
ch_int <- chicagoHouse$valence

dtint <- sample(dt_int, size = 80)
chint <- sample(ch_int, size = 80)


# Create data frame 


 x = c(c(dtenergy), c(dtdance),c(dtval), c(dtint), c(chenergy), c(chdance), c(chval), c(chint))
y = rep(c("Detroit", "Detroit","Detroit","Detroit","Chicago","Chicago","Chicago", "Chicago"))
z = rep(c("Energy", "Danceability", "Valence", "Insturmentalness"), 2)

energy3 = data.frame(x, y, z)

# Check data fram 
# str(energy3)
# head(energy3)

# Box Plot 
ggplot(energy3, aes(y, x, fill= factor(z))) +
  geom_boxplot() + 
  theme(axis.title = element_blank()) + 
  labs(
    title="Detroit Techno vs Chicago House", 
    fill = "Features", 
    x = "Detroit Techno vs Chicago House")

#point plot
ggplot(detroitTechno, (aes(tempo, loudness, color = key, size = energy))) +
  geom_point() +
  ggtitle("Detriot Techno")

ggplot(chicagoHouse, (aes(tempo, loudness, color = key, size = energy ))) +
  geom_point() +
  ggtitle("Chicago House")

```

***

Chicago house is slightly greater danceability factor and greater positive emotional valence reflecting its disco and funk roots. Detroit techno has more energy and on average, less vocals, however it’s interesting to see that Chicago has more instrumental outliers on the lower spectrum considering that usually house has more vocals  

Chicago house has more consistent tempo between 120 –125 bpm and a few outliers that are mostly all in higher keys compared to Detroit techno. It has a slightly wider spread of bpm with many tracks over 130 bpm and a range of key values in outlier positions.  


### Chicago House Vs Early Acid  

```{r, echo=FALSE}

## load spotify
my_id <- 'natzaw'

chicagoHouse <- get_playlist_audio_features(my_id, "5ZixL1Pb2mzyED9hSQ8y2G")
earlyAcid  <- get_playlist_audio_features(my_id, "1Ybjwa5pLtVCqlXrIrOOiF")


#danceacility
ca_dance <- earlyAcid$danceability
ch_dance <- chicagoHouse$danceability

cadance <- sample(ca_dance, size = 57)
chdance <- sample(ch_dance, size = 57)

# energy
ca_energy <- earlyAcid$energy
ch_energy <- chicagoHouse$energy

caenergy <- sample(ca_energy, size = 57)
chenergy <- sample(ch_energy, size = 57)

# valence
ca_val <- earlyAcid$valence
ch_val <- chicagoHouse$valence

caval <- sample(ca_val, size = 57)
chval <- sample(ch_val, size = 57)

#instrumentalness
ca_int <- earlyAcid$valence
ch_int <- chicagoHouse$valence

caint <- sample(ca_int, size = 57)
chint <- sample(ch_int, size = 57)


# Create data frame 
x = c(c(caenergy), c(cadance),c(caval), c(caint), c(chenergy), c(chdance), c(chval), c(chint))
y = rep(c("Acid", "Acid","Acid","Acid","House","House","House", "House"))
z = rep(c("Energy", "Danceability", "Valence", "Insturmentalness"), 2)

energy3 = data.frame(x, y, z)

# Check data fram 
# str(energy3)
# head(energy3)

# Box Plot 
ggplot(energy3, aes(y, x, fill= factor(z))) +
  geom_boxplot() + 
  theme(axis.title = element_blank()) + 
  labs(
    title="Chicago House vs Early Acid", 
    fill = "Features", 
    x = "Chicago House vs Early Acid")

#point plot 
ggplot(earlyAcid, (aes(tempo, loudness, color = key, size = energy))) +
  geom_point() +
  ggtitle("Early Acid")

ggplot(chicagoHouse, (aes(tempo, loudness, color = key, size = energy ))) +
  geom_point() +
  ggtitle("Chicago House")


```

***

This boxplot surprised me a bit. The features are more similar than I expected. Because of its harsher sound, acid valence and instrumentalness is higher than I thought and would not expect it to surpass house, although it does have more outliers on the low spectrum. Acid danceability is lower than house which make sense due to house’s funk and disco roots. 

Acid has a much higher average bpm, around 135, in a variety of key values however there is a clear pattern where higher energy indicated higher loudness and lower key on average.   



### Chroma Features: Techno vs House vs Acid 

```{r, echo=FALSE}

# CHROMAGRAM

#load tracks
acidTrack <-                                                 # Acid Tracks - Phuture
  get_tidy_audio_analysis("0mjTZVkrnX26IuuxgNR7Sa") %>%      # change URI
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

# houseTrack <-                                      # Move Your Body-MarshallJeff
#   get_tidy_audio_analysis("7FHFK1b7mjiPPENBwp9F1t") %>%      # change URI
#   select(segments) %>%
#   unnest(segments) %>%
#   select(start, duration, pitches)

houseTrack2 <-                                    # Can you feel it- Mr.Fingers
  get_tidy_audio_analysis("5479eh8cRkMdukYI3gtO36") %>%      # change URI
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

technoTrack <-                                    # Energy Flash - JB
  get_tidy_audio_analysis("4A267WBgSQfHlnRczm6M3s") %>%      # change URI
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

# technoTrack2 <-                                    # House is Mine - Hypnotist
#   get_tidy_audio_analysis("4kbzPGFkJPzCWrNOJXKVi0") %>%      # change URI
#   select(segments) %>%
#   unnest(segments) %>%
#   select(start, duration, pitches)

# gather_chromas


# acid track:  euclidean
acidTrack %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Acid: Acid Tracks - Phuture") +
  theme_minimal() +
  scale_fill_viridis_c()


# # house track 1 : euclidean
# houseTrack %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   theme_minimal() +
#   scale_fill_viridis_c()


# house track 2 : euclidean
houseTrack2 %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "House: Can you feel it - Mr.fingers") +
  theme_minimal() +
  scale_fill_viridis_c()

# Techno track 1 : euclidean
technoTrack %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = " Techno: Energy Flash - Joey Beltram") +
  theme_minimal() +
  scale_fill_viridis_c()


# # Techno track 2 : euclidean
# technoTrack2 %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   theme_minimal() +
#   scale_fill_viridis_c()


```

***

Here I looked at three popular tracks of each genre.  

The acid track has a clear C, C# and B chroma pattern which was interesting to see considering the main sound feature of acid is the oscillating synth chord that I expected would be difficult for spotify to define.  

The house track has predominately A pitch class that I think is attributed to the bassline.  

The techno track has mainly G3 pitch class most likely attributed to the bassline as well. I thought the synth cord that comes in at 0:45 sec would be identifiable but I could not place it in the chromagram.  

### Ceptogram + SSM: Techno vs House

```{r, echo=FALSE}


####### CEPTOGRAM: check page for common norm, distance, summary combinations

# ### ENERGY FLASH 
# # load track features
# energyFlash <-                                          # change trackName
#   get_tidy_audio_analysis("4A267WBgSQfHlnRczm6M3s") %>% # Change URI.
#   compmus_align(bars, segments) %>%                     # Change `bars`
#   select(bars) %>%                                      #   in all three
#   unnest(bars) %>%                                      #   of these lines
#   mutate(                                               # to either: sections, bars, beats, tatums
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "rms", norm = "euclidean"              # Change summary & norm
#       )                                                 # summary : mean, acentre, rms, max
#   ) %>%                                                 # norm: manhattan, euclidean, chebyshev
#   mutate(
#     timbre =
#       map(segments,
#         compmus_summarise, timbre,
#         method = "rms", norm = "euclidean"              # Change summary & norm.
#       )
#   )
# 
# # ceptogram; compmus_gather_timbre
# 
# energyFlash %>%                                                 # change trackName
#   compmus_gather_timbre() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = basis,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   scale_fill_viridis_c() +
#   theme_classic()
# 
# # self-similarity matrix(timbre): check page for other combos (pitches )
# energyFlash %>%
#   compmus_self_similarity(timbre, "cosine") %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   scale_fill_viridis_c(guide = "none") +
#   theme_classic() +
#   labs(x = "", y = "")

### CAPRICORN  
# load track features
capricorn20hz <-                                          # change trackName
  get_tidy_audio_analysis("7itMoq9KycP73X2AMdhp2i") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines
  mutate(                                               # to either: sections, bars, beats, tatums
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm
      )                                                 # summary : mean, acentre, rms, max
  ) %>%                                                 # norm: manhattan, euclidean, chebyshev
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

# ceptogram; compmus_gather_timbre

capricorn20hz %>%                                                 # change trackName
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Techno: 20hz - Capricorn") +
  scale_fill_viridis_c() +
  theme_classic()

# self-similarity matrix(timbre): check page for other combos (pitches )
capricorn20hz %>%
  compmus_self_similarity(timbre, "cosine") %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title = "Techno: 20hz - Capricorn")

# ### House is Mine  
# # load track features
# houseMine <-                                          # change trackName
#   get_tidy_audio_analysis("4kbzPGFkJPzCWrNOJXKVi0") %>% # Change URI.
#   compmus_align(bars, segments) %>%                     # Change `bars`
#   select(bars) %>%                                      #   in all three
#   unnest(bars) %>%                                      #   of these lines
#   mutate(                                               # to either: sections, bars, beats, tatums
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "rms", norm = "euclidean"              # Change summary & norm
#       )                                                 # summary : mean, acentre, rms, max
#   ) %>%                                                 # norm: manhattan, euclidean, chebyshev
#   mutate(
#     timbre =
#       map(segments,
#         compmus_summarise, timbre,
#         method = "rms", norm = "euclidean"              # Change summary & norm.
#       )
#   )
# 
# # ceptogram; compmus_gather_timbre
# 
# houseMine %>%                                                 # change trackName
#   compmus_gather_timbre() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = basis,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   scale_fill_viridis_c() +
#   theme_classic()
# 
# # self-similarity matrix(timbre): check page for other combos (pitches )
# houseMine %>%
#   compmus_self_similarity(timbre, "cosine") %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   scale_fill_viridis_c(guide = "none") +
#   theme_classic() +
#   labs(x = "", y = "")

### MYSTERY OF LOVE   
# load track features
mysteryLove <-                                          # change trackName
  get_tidy_audio_analysis("6AvtRMA6AzFNYZ3qEMYpch") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines
  mutate(                                               # to either: sections, bars, beats, tatums
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm
      )                                                 # summary : mean, acentre, rms, max
  ) %>%                                                 # norm: manhattan, euclidean, chebyshev
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

# ceptogram; compmus_gather_timbre

mysteryLove %>%                                                 # change trackName
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = " House: Mystery of Love - Mr.Fingers") +
  scale_fill_viridis_c() +
  theme_classic()

# self-similarity matrix(timbre): check page for other combos (pitches )
mysteryLove %>%
  compmus_self_similarity(timbre, "cosine") %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title = "House: Mystery of Love - Mr.Fingers")

# ### RIDE THE RHYTHM   
# # load track features
# rideRhythm <-                                          # change trackName
#   get_tidy_audio_analysis("3PNLv77dzEsWs7MV2ouKc8") %>% # Change URI.
#   compmus_align(bars, segments) %>%                     # Change `bars`
#   select(bars) %>%                                      #   in all three
#   unnest(bars) %>%                                      #   of these lines
#   mutate(                                               # to either: sections, bars, beats, tatums
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "rms", norm = "euclidean"              # Change summary & norm
#       )                                                 # summary : mean, acentre, rms, max
#   ) %>%                                                 # norm: manhattan, euclidean, chebyshev
#   mutate(
#     timbre =
#       map(segments,
#         compmus_summarise, timbre,
#         method = "rms", norm = "euclidean"              # Change summary & norm.
#       )
#   )
# 
# # ceptogram; compmus_gather_timbre
# 
# rideRhythm %>%                                                 # change trackName
#   compmus_gather_timbre() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = basis,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   scale_fill_viridis_c() +
#   theme_classic()
# 
# # self-similarity matrix(timbre): check page for other combos (pitches )
# rideRhythm %>%
#   compmus_self_similarity(timbre, "cosine") %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   scale_fill_viridis_c(guide = "none") +
#   theme_classic() +
#   labs(x = "", y = "")


```

***

Here I looked at a popular techno and house track to compare timbre features.  

The most prominent feature of the techno track is the loud Brazilian batucada percussion that drop in two sections which shows up as strong c02 vibrance. Between these sections is a panning synth that seems to shows up in c05 and /or c09.  

The house track has less concentrated timbre features with a few highlights at around 250 and 300 seconds.   

The self-similarity matrices show that the techno has slightly less repetition than the house track which makes sense in that the techno track has several distinguishing segments while the house tracks is rather repetitive. The two bright seem to corresponds with a clear break in the tracks where the piano chords go a little whack.  

### Chordogram

```{r, echo=FALSE}

#chordogram
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )



#load track : Moby - Go
mobyGo <-
  get_tidy_audio_analysis("6bzV0xGO4dROmmL9GmVkjM") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

mobyGo %>%
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "euclidean"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Moby - Go")


#load track : Laura's Theme - Angelo Badalamenti
lauraTheme <-
  get_tidy_audio_analysis("7Bk3p8UqcP4sItaWNWbvXL") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

lauraTheme %>%
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "euclidean"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Twin Peaks - Laura's Theme")

#load track : Acid Tracks - Phuture
acidTracks <-
  get_tidy_audio_analysis("63eiF9VouGtmhiBKjm1LHU") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

acidTracks %>%
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "euclidean"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Acid Tracks - Phuture")

#load track : House is Mine - Hypnotist
houseMine2 <-
  get_tidy_audio_analysis("4kbzPGFkJPzCWrNOJXKVi0") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

houseMine2 %>%
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = " House is Mine - Hypnotist")

#load track : EnergyFlash - JB
energFlash <-
  get_tidy_audio_analysis("4A267WBgSQfHlnRczm6M3s") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

energFlash %>%
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = " Energy Flash - Joey Beltram ")

#load track
mysteryLove <-
  get_tidy_audio_analysis("6AvtRMA6AzFNYZ3qEMYpch") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

mysteryLove %>%
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = " Mystery of Love - Mr.Fingers")





# 
# # comparing average timbre coefficients in bebop and big band
# 
# techHouse %>%
#   mutate(
#     timbre =
#       map(
#         segments,
#         compmus_summarise,
#         timbre,
#         method = "mean"
#       )
#   ) %>%
#   select(genre, timbre) %>%
#   compmus_gather_timbre() %>%
#   ggplot(aes(x = basis, y = value, fill = genre)) +
#   geom_violin() +
#   scale_fill_viridis_d() +
#   labs(x = "Spotify Timbre Coefficients", y = "", fill = "Genre")

```

***

Commentary Here

### Novelty Function & Ceptogram: House is Mine 

```{r, echo=FALSE}


# novelty function

#  work directly with the segments

houseMine <-
  get_tidy_audio_analysis("4kbzPGFkJPzCWrNOJXKVi0") %>%
  select(segments) %>%
  unnest(segments)

# can compute an energy-based novelty function based on Spotify’s loudness estimates

houseMine %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 30) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty", title = "House is Mine - Hypnotist")

# can use similar approaches for chromagrams and cepstrograms

# compmus_gather_chroma

houseMine %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  arrange(start) %>%
  mutate(pitches = map2(pitches, lag(pitches), `-`)) %>%
  slice(-1) %>%
  compmus_gather_chroma() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = pmax(0, value)
    )
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  xlim(0, 30) +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "House is Mine - Hypnotist") +
  theme_classic()

# compmus_gather_timbre

houseMine %>%
  arrange(start) %>%
  mutate(timbre = map2(timbre, lag(timbre), `-`)) %>%
  slice(-1) %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = pmax(0, value)
    )
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  xlim(0, 30) +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "House is Mine - Hypnotist") +
  theme_classic()

# # temporgrams
# 
# houseMine <- get_tidy_audio_analysis("4kbzPGFkJPzCWrNOJXKVi0")
# 
# houseMine %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)", title = "House is Mine - Hypnotist") +
#   theme_classic()

# #  Wrapping into a cyclic tempogram
# houseMine %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()

```

***

Commentary Here

### Loudness

```{r, echo=FALSE}

# track level summaries

europeTechno <-
  get_playlist_audio_features(
    my_id, "1YnOhBchUwaRFOqzWZp4CV"
  ) %>%
  slice(1:30) %>%
  add_audio_analysis()

chicagoHouse <-
  get_playlist_audio_features(
    my_id, "5ZixL1Pb2mzyED9hSQ8y2G"
  ) %>%
  slice(1:30) %>%
  add_audio_analysis()

techHouse <-
  europeTechno %>%
  mutate(genre = "Europe Techno") %>%
  bind_rows(chicagoHouse %>% mutate(genre = "Chicago House"))

#summarize statistics

techHouse %>%
  mutate(
    sections =
      map(
        sections,                                    # sections or segments
        summarise_at,
        vars(tempo, loudness, duration),             # features of interest
        list(section_mean = mean, section_sd = sd)   # aggregation functions
      )
  ) %>%
  unnest(sections) %>%
  ggplot(
    aes(
      x = tempo,
      y = tempo_section_sd,
      colour = genre,
      alpha = loudness
    )
  ) +
  geom_point(aes(size = duration / 60)) +
  geom_rug() +
  theme_minimal() +
  ylim(0, 5) +
  labs(
    x = "Mean Tempo (bpm)",
    y = "SD Tempo",
    colour = "Genre",
    size = "Duration (min)",
    alpha = "Volume (dBFS)"
  )


```

***

Commentary Here

### Classification

```{r, echo=FALSE}

#load libraries 

# library(tidyverse)
# library(tidymodels)
# library(ggdendro)
# library(heatmaply)
# library(spotifyr)
# library(compmus)

# set up
get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>%
    collect_predictions() %>%
    conf_mat(truth = outcome, estimate = .pred_class)
}

get_pr <- function(fit) {
  fit %>%
    conf_mat_resampled() %>%
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>%
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>%
    ungroup() %>% filter(Prediction == Truth) %>%
    select(class = Prediction, precision, recall)
}

#classification

berlin <- get_playlist_audio_features("spotify", "1YnOhBchUwaRFOqzWZp4CV")
detroit <- get_playlist_audio_features("spotify", "7zJxmBOEVValZYC0zmfLrf")
chicago <- get_playlist_audio_features("spotify", "5ZixL1Pb2mzyED9hSQ8y2G")
techno_acid <-
  bind_rows(
    berlin %>% mutate(playlist = "Early Berlin") %>% slice_head(n = 10),
    detroit %>% mutate(playlist = "Early Detroit") %>% slice_head(n = 10),
    chicago %>% mutate(playlist = "Early Chicago") %>% slice_head(n = 10)
  )

# bind the three playlists together using the trick from the beginning of the course, transpose the chroma vectors to a common tonic using the compmus_c_transpose function, and then summarise the vectors like we did when generating chromagrams and cepstrograms

techno_acid_features <-
  techno_acid %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>%
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

#pre-processing

techno_acid_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = techno_acid_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].

# cross- validation

techno_acid_cv <- techno_acid_features %>% vfold_cv(5)

#classification algorithms: kNN

# Decision Trees

# Random Forest

forest_model <-
  rand_forest() %>%
  set_mode("classification") %>%
  set_engine("ranger", importance = "impurity")
techno_acid_forest <-
  workflow() %>%
  add_recipe(techno_acid_recipe) %>%
  add_model(forest_model) %>%
  fit_resamples(
    techno_acid_cv,
    control = control_resamples(save_pred = TRUE)
  )

techno_acid_forest %>% get_pr()

workflow() %>%
  add_recipe(techno_acid_recipe) %>%
  add_model(forest_model) %>%
  fit(techno_acid_features) %>%
  pluck("fit", "fit", "fit") %>%
  ranger::importance() %>%
  enframe() %>%
  mutate(name = fct_reorder(name, value)) %>%
  ggplot(aes(name, value)) +
  geom_col() +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")

# ggplot

techno_acid_features %>%
  ggplot(aes(x = tempo, y = c05, colour = playlist, size = loudness)) +
  geom_point(alpha = 0.8) +
  scale_color_viridis_d() +
  labs(
    x = "Tempo",
    y = "Timbre Component 5",
    size = "Loudness",
    colour = "Playlist"
  )

# #clustering 
# 
# early_chicago <-
#   get_playlist_audio_features("Early Chicago", "5ZixL1Pb2mzyED9hSQ8y2G") %>%
#   add_audio_analysis() %>%
#   mutate(
#     segments = map2(segments, key, compmus_c_transpose),
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "mean", norm = "manhattan"
#       ),
#     timbre =
#       map(
#         segments,
#         compmus_summarise, timbre,
#         method = "mean"
#       )
#   ) %>%
#   mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
#   mutate_at(vars(pitches, timbre), map, bind_rows) %>%
#   unnest(cols = c(pitches, timbre))
# 
# # pre-processing
# 
# chicago_juice <-
#   recipe(
#     track.name ~
#       danceability +
#       energy +
#       loudness +
#       speechiness +
#       acousticness +
#       instrumentalness +
#       liveness +
#       valence +
#       tempo +
#       duration +
#       C + `C#|Db` + D + `D#|Eb` +
#       E + `F` + `F#|Gb` + G +
#       `G#|Ab` + A + `A#|Bb` + B +
#       c01 + c02 + c03 + c04 + c05 + c06 +
#       c07 + c08 + c09 + c10 + c11 + c12,
#     data = early_chicago
#   ) %>%
#   step_center(all_predictors()) %>%
#   step_scale(all_predictors()) %>%
#   # step_range(all_predictors()) %>%
#   prep(early_chicago %>% mutate(track.name = str_trunc(track.name, 20))) %>%
#   juice() %>%
#   column_to_rownames("track.name")
# 
# # computing disctances
# 
# acid_dist <- dist(chicago_juice, method = "euclidean")
# 
# # hierarchical clustering
# 
# chicago_dist %>%
#   hclust(method = "average") %>% # Try single, average, and complete.
#   dendro_data() %>%
#   ggdendrogram()
```

***

Commentary Here


### Chart 3

```{r, echo=FALSE}

library(dplyr) # or install.packages("dplyr") first
library(jasmines) # or devtools::install_github("djnavarro/jasmines")

## load spotify
my_id <- 'natzaw'

acidTracks <- get_tidy_audio_analysis("0mjTZVkrnX26IuuxgNR7Sa")



#features
at_tempo <- acidTracks$tempo
at_energy <- acidTracks$energy

str(acidTracks)

p0 <- use_seed(128) %>% # Set the seed of R‘s random number generator, 
  scene_discs(
    rings = 7, 
    points = 5000, 
    size = 50
  ) %>%
  mutate(ind = 1:n()) %>%
  unfold_warp(
    iterations = 4,
    scale = 0.7, 
    output = "layer" 
  ) %>%
  unfold_tempest(
    iterations = 6,
    scale = .02
  ) %>%
  style_ribbon(
    color = "black",
    colour = "ind",
    alpha = c(1,1),
    background = "white"
  )

p0

# ggsave("p0.png", p0, width = 20, height = 20, units = "in")
```

***

Commentary Here




Discussion
=========================================

Discussion Here




